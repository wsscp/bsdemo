CREATE OR REPLACE 
PROCEDURE "CANCEL_WORK_ORDER" (WORKORDERNO IN VARCHAR2, UPDATOR IN VARCHAR2)
AS
	NOW CONSTANT TIMESTAMP:=SYSDATE;
	FINISHED CONSTANT VARCHAR2(10):='FINISHED';
	CANCELED CONSTANT VARCHAR2(10):='CANCELED';
	TO_CONFIRM CONSTANT VARCHAR2(15):='TO_CONFIRM';
	IN_PROGRESS CONSTANT VARCHAR2(15):='IN_PROGRESS';
	ISSUED CONSTANT VARCHAR2(15):='ISSUED';


BEGIN

	-- 修改相关OrderTask状态为已取消
	UPDATE T_PLA_ORDER_TASK T
		SET T.STATUS = CANCELED, T.MODIFY_USER_CODE = UPDATOR, T.MODIFY_TIME = NOW
	WHERE T.WORK_ORDER_NO = WORKORDERNO ;
	
	-- 修改相关未生产和生产中的WorkOrder的状态为已取消
	UPDATE T_WIP_WORK_ORDER W
		SET W.STATUS = CANCELED, W.MODIFY_USER_CODE = UPDATOR, W.MODIFY_TIME = NOW
	WHERE W.STATUS NOT IN (CANCELED,FINISHED) AND  W.WORK_ORDER_NO = WORKORDERNO ;
	
	-- 修改未生产的WorkOrder的物料需求清单为取消
	UPDATE T_PLA_MRP M
		SET M.STATUS = CANCELED, M.MODIFY_USER_CODE = UPDATOR, M.MODIFY_TIME = NOW
	WHERE EXISTS(
		SELECT 1 
		FROM T_PLA_ORDER_TASK W 
		WHERE M.WORK_ORDER_ID = W."ID" AND W.STATUS NOT IN (ISSUED)
		AND  W.WORK_ORDER_NO = WORKORDERNO
	); 
	
	-- 修改未生产的WorkOrder的工装夹具需求清单状态为取消
	UPDATE T_PLA_TOOLES_RP M
		SET M.STATUS = CANCELED, M.MODIFY_USER_CODE = UPDATOR, M.MODIFY_TIME = NOW
	WHERE EXISTS(
		SELECT 1 
		FROM T_PLA_ORDER_TASK W 
		WHERE M.WORK_ORDER_ID = W."ID" AND W.STATUS NOT IN (ISSUED) 
		AND  W.WORK_ORDER_NO = WORKORDERNO
	)  ;
	
	-- 修改生产中的WorkOrder的已取消长度
	UPDATE T_WIP_WORK_ORDER W
		SET W.CANCEL_LENGTH = (
			SELECT SUM(T.TASK_LENGTH) FROM T_PLA_ORDER_TASK T
			WHERE W.WORK_ORDER_NO = T.WORK_ORDER_NO
		), W.MODIFY_USER_CODE = UPDATOR, W.MODIFY_TIME = NOW
	WHERE W.STATUS = IN_PROGRESS AND  W.WORK_ORDER_NO = WORKORDERNO ;
	
	
END;
