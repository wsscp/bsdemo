CREATE OR REPLACE
PROCEDURE "FINISH_ORDER_ITEM" (ORDERITEMID IN VARCHAR2, UPDATOR IN VARCHAR2)
AS
    finisOrderNum  NUMBER(10) DEFAULT 0;

BEGIN
	
        -- 2、更新订单明细和客户订单明细
        UPDATE T_PLA_CUSTOMER_ORDER_ITEM SET STATUS = 'FINISHED',MODIFY_TIME = SYSDATE,MODIFY_USER_CODE = UPDATOR WHERE ID = ORDERITEMID;
        UPDATE T_ORD_SALES_ORDER_ITEM A SET STATUS = 'FINISHED',MODIFY_TIME = SYSDATE,MODIFY_USER_CODE = UPDATOR WHERE EXISTS (
            SELECT B.ID FROM T_PLA_CUSTOMER_ORDER_ITEM B WHERE B.ID = ORDERITEMID AND A.ID = B.SALES_ORDER_ITEM_ID
        );

        -- 3、查询合同下的订单是否都完成
        SELECT
            COUNT(A.ID) INTO finisOrderNum
        FROM T_PLA_CUSTOMER_ORDER_ITEM A WHERE A.STATUS IN ('TO_DO','IN_PROGRESS') AND EXISTS (
          SELECT B.ID FROM T_PLA_CUSTOMER_ORDER_ITEM B WHERE B.ID = ORDERITEMID AND B.CUSTOMER_ORDER_ID = A.CUSTOMER_ORDER_ID
        );

        IF finisOrderNum = 0 THEN
        	-- 4、更新合同和客户合同
            UPDATE T_PLA_CUSTOMER_ORDER A SET STATUS = 'FINISHED',MODIFY_TIME = SYSDATE,MODIFY_USER_CODE = UPDATOR WHERE EXISTS (
                SELECT B.ID FROM T_PLA_CUSTOMER_ORDER_ITEM B WHERE B.ID = ORDERITEMID AND A.ID = B.CUSTOMER_ORDER_ID
            );

            UPDATE T_ORD_SALES_ORDER A SET STATUS = 'FINISHED',MODIFY_TIME = SYSDATE,MODIFY_USER_CODE = UPDATOR WHERE EXISTS (
                SELECT
                    B.ID
                FROM T_PLA_CUSTOMER_ORDER B
                  LEFT JOIN T_PLA_CUSTOMER_ORDER_ITEM C ON B.ID = C.CUSTOMER_ORDER_ID
                WHERE C.ID = ORDERITEMID
                AND A.ID = B.SALES_ORDER_ID
            );
        END IF;
END;