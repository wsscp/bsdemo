CREATE OR REPLACE PROCEDURE "INIT_ORDERTASK"(V_ORG_CODE IN VARCHAR2) AS
BEGIN
  -- 锁定数据：正在加工中的POR_DEC, 根据ORDER_ITEM_DEC_ID和工序来确定锁定数据
  -- 1、锁定数据：T_PLA_CU_ORDER_ITEM_PRO_DEC_OA
  UPDATE T_PLA_CU_ORDER_ITEM_PRO_DEC_OA
     SET IS_LOCKED = '1'
   WHERE IS_LOCKED = '0'
     AND ORG_CODE = V_ORG_CODE
     AND ID IN (SELECT PDOA.ID
                  FROM T_PLA_CU_ORDER_ITEM_PRO_DEC_OA PDOA,
                       T_PLA_CU_ORDER_ITEM_PRO_DEC    PD
                 WHERE PDOA.ORDER_ITEM_DEC_ID = PD.ORDER_ITEM_DEC_ID
                   AND PDOA.PROCESS_ID = PD.PROCESS_CODE
                   AND PDOA.ORG_CODE = V_ORG_CODE
                   AND PD.ORG_CODE = V_ORG_CODE
                   AND PD.STATUS = 'IN_PROGRESS');

  -- 删除数据：为锁定的
  -- 2、删除数据：T_FAC_WORK_TASKS
  DELETE FROM T_FAC_WORK_TASKS
   WHERE ORDER_ITEM_PRO_DEC_ID IN
         (SELECT ID
            FROM T_PLA_CU_ORDER_ITEM_PRO_DEC_OA
           WHERE ORG_CODE = V_ORG_CODE
             AND IS_LOCKED = '1');

  -- 3、删除数据：T_PLA_MRP_OA
  DELETE FROM T_PLA_MRP_OA
   WHERE ORDER_ITEM_PRO_DEC_ID IN
         (SELECT ID
            FROM T_PLA_CU_ORDER_ITEM_PRO_DEC_OA
           WHERE ORG_CODE = V_ORG_CODE
             AND IS_LOCKED = '1');
  
  -- 3、删除数据：中间表 T_PLA_OA_UPTEMP
  DELETE FROM T_PLA_OA_UPTEMP
   WHERE ORG_CODE = V_ORG_CODE;
   
  COMMIT;
END;
