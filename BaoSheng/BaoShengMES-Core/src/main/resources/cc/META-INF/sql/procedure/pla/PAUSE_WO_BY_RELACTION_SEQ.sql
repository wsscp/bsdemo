--终端调整2个生产单的优先级
--原正在生产的生产单号
--目标生产单号
--设备code
--操作员工
CREATE OR REPLACE PROCEDURE "PAUSE_WO_BY_RELACTION_SEQ"(
          V_OLDWORKORDERNO IN VARCHAR ,
          V_NEWWORKORDERNO IN VARCHAR ,
          V_EQUIPCODE IN VARCHAR ,
          V_OPERATOR IN VARCHAR )
AS
  V_MAX_SEQ NUMBER;
  V_OLD_WO_ID VARCHAR2(50);
  V_NEW_WO_ID VARCHAR2(50);
BEGIN
	-- 1、查询数据
    SELECT ID INTO V_OLD_WO_ID FROM T_WIP_WORK_ORDER WHERE WORK_ORDER_NO = V_OLDWORKORDERNO;
    SELECT ID INTO V_NEW_WO_ID FROM T_WIP_WORK_ORDER WHERE WORK_ORDER_NO = V_NEWWORKORDERNO;
    -- 2、更新旧生产单状态暂停
    -- UPDATE T_WIP_WORK_ORDER SET STATUS = 'TO_DO' WHERE WORK_ORDER_NO = V_OLDWORKORDERNO;

    -- 3、查询当前设备上最大的SEQ
    SELECT
      MAX(T1.SEQ) INTO V_MAX_SEQ
    FROM T_WIP_WO_EQUIP_RELATION T1
    WHERE T1.EQUIP_CODE = V_EQUIPCODE
    AND EXISTS (SELECT 1 FROM T_WIP_WORK_ORDER T2 WHERE T2.ID = T1.WORK_ORDER_ID AND T2.STATUS IN ('IN_PROGRESS','TO_DO'));


    V_MAX_SEQ := V_MAX_SEQ + 1;
    UPDATE T_WIP_WO_EQUIP_RELATION T1 SET T1.SEQ = V_MAX_SEQ,T1.MODIFY_TIME = SYSDATE,MODIFY_USER_CODE=V_OPERATOR
    WHERE T1.EQUIP_CODE = V_EQUIPCODE AND T1.WORK_ORDER_ID = V_OLD_WO_ID;

    UPDATE T_WIP_WO_EQUIP_RELATION T1 SET T1.SEQ = 1,T1.MODIFY_TIME = SYSDATE,MODIFY_USER_CODE=V_OPERATOR
    WHERE T1.EQUIP_CODE = V_EQUIPCODE AND T1.WORK_ORDER_ID = V_NEW_WO_ID;
    
END PAUSE_WO_BY_RELACTION_SEQ;
