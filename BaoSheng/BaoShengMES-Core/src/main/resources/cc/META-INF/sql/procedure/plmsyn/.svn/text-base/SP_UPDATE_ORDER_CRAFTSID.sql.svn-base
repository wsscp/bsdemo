--在同步PLM最新工艺的时候更新现有一个月内的订单工艺
CREATE OR REPLACE PROCEDURE SP_UPDATE_ORDER_CRAFTSID AS
  LASTDAY T_EVE_LAST_EXECUTE_TIME_RECORD.LAST_EXECUTE_TIME%TYPE;
  ----在同步PLM最新工艺的时候更新现有一个月内的订单工艺
BEGIN
  SELECT WA.LAST_EXECUTE_TIME
    INTO LASTDAY
    FROM T_EVE_LAST_EXECUTE_TIME_RECORD WA
   WHERE WA.TYPE = 'CRAFTSID';
  FOR X IN (SELECT HH.PRODUCT_CODE, MAX(HH.CREATE_TIME) AS CREATE_TIME
              FROM T_PRO_PRODUCT_CRAFTS_R HH
             WHERE HH.PRODUCT_CRAFTS_ID IN
                   (SELECT H.ID
                      FROM T_PRO_PRODUCT_CRAFTS H
                     WHERE H.CREATE_TIME >= LASTDAY)
             GROUP BY HH.PRODUCT_CODE) LOOP
    UPDATE T_PLA_CUSTOMER_ORDER_ITEM C
       SET C.CRAFTS_ID =
           (SELECT PRODUCT_CRAFTS_ID
              FROM T_PRO_PRODUCT_CRAFTS_R
             WHERE PRODUCT_CODE = X.PRODUCT_CODE
               AND CREATE_TIME = X.CREATE_TIME)
     WHERE C.PRODUCT_CODE = X.PRODUCT_CODE
       AND C.CREATE_TIME > SYSDATE - 30;
  END LOOP;

  UPDATE T_EVE_LAST_EXECUTE_TIME_RECORD WA
     SET WA.LAST_EXECUTE_TIME =
         (SELECT L.LAST_EXECUTE_TIME
            FROM T_EVE_LAST_EXECUTE_TIME_RECORD L
           WHERE L.TYPE = 'PRCV')
   WHERE WA.TYPE = 'CRAFTSID';
END SP_UPDATE_ORDER_CRAFTSID;
